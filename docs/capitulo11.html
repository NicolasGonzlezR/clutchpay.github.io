<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cap√≠tulo 11: Backend de Pagos y Stripe - ClutchPay</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>üí∞ ClutchPay</h1>
            <p class="subtitle">Cap√≠tulo 11: Backend de Pagos y Stripe</p>
        </div>
    </header>

    <nav class="main-nav">
        <div class="container">
            <a href="index.html">Inicio</a>
            <a href="capitulo11.html" class="active">Cap√≠tulo 11</a>
        </div>
    </nav>

    <main class="container">
        <div class="back-nav">
            <a href="index.html" class="back-btn">‚Üê Volver al √≠ndice</a>
        </div>

        <div class="chapter-content">
            <div class="chapter-header">
                <h1>Cap√≠tulo 11: Backend de Pagos y Stripe</h1>
            </div>

            <div class="video-embed">
                <iframe
                    src="https://drive.google.com/file/d/1ve8-hBIT_dlMfSAkqUxUfR04qXxBN4FC/preview"
                    title="Video tutorial - Cap√≠tulo 11"
                    allow="autoplay; encrypted-media"
                    allowfullscreen
                ></iframe>
            </div>

            <div class="content-section">
                <h2>üìñ Contenido Completo</h2>
                <div class="markdown-body">
                    <h1>Implementaci√≥n de Gesti√≥n de Pagos y Sesiones en Stripe</h1>
                    <p>Este tutorial se configura para manejar los pagos de facturas a trav√©s de <strong>Stripe</strong>, junto con la gesti√≥n de sesiones de pago y verificaci√≥n del estado de los pagos.</p>
                    
                    <h2>1. Estructura de archivos de pruebas y configuraci√≥n</h2>
                    <ul>
                        <li><strong>src/libs/validations/payment.ts</strong>: Define los schemas de validaci√≥n para los pagos utilizando Zod. Estos incluyen las validaciones para la lista de pagos con filtros, rangos de monto y fechas de pago.</li>
                        <li><strong>src/libs/validations/stripe.ts</strong>: Define los schemas de validaci√≥n para las operaciones relacionadas con Stripe, como la creaci√≥n de sesiones de pago y la validaci√≥n de eventos de Stripe Webhooks.</li>
                        <li><strong>src/libs/stripe.ts</strong>: Archivo que gestiona la interacci√≥n con la API de Stripe, creando sesiones de pago, verificando firmas de webhooks y mapeando estados de sesiones. Contiene funciones para crear una sesi√≥n de pago en Stripe, manejar errores y convertir montos de pago entre formato decimal y centavos.</li>
                        <li><strong>src/app/api/payments/route.ts</strong>: Este archivo maneja las operaciones para obtener una lista paginada de los pagos realizados o recibidos por el usuario autenticado. Soporta filtros como el m√©todo de pago, el rango de monto y fechas, y permite ordenar los resultados.</li>
                        <li><strong>src/app/api/payments/[id]/route.ts</strong>: Permite acceder a los detalles de un pago espec√≠fico, asegurando que solo el pagador (deudor) o el receptor (emisor) de la factura puedan consultar el pago.</li>
                        <li><strong>src/app/api/payments/stripe/checkout/route.ts</strong>: Crea una sesi√≥n de pago de Stripe Checkout para un pago de factura. Solo el deudor (quien debe la factura) puede iniciar el pago. La factura debe tener un estado pendiente o vencido para ser pagada.</li>
                        <li><strong>src/app/api/payments/stripe/session/[sessionId]/route.ts</strong>: Recupera el estado y los detalles de una sesi√≥n de pago de Stripe usando el <code>sessionId</code>. Solo el pagador o receptor involucrado en la sesi√≥n de pago puede acceder a la informaci√≥n.</li>
                    </ul>
                    
                    <h2>2-9. Descripci√≥n de Componentes</h2>
                    <ul>
                        <li><strong>prisma/schema.prisma</strong>: Contiene el modelo Invoice con relaciones a usuarios y pagos, permitiendo gestionar facturas y asociarlas con usuarios.</li>
                        <li><strong>src/libs/validations/invoice.ts</strong>: Schemas de validaci√≥n para operaciones con facturas (crear, actualizar, registrar pagos).</li>
                        <li><strong>src/app/api/invoices/route.ts</strong>: Gestiona listado y creaci√≥n de facturas con paginaci√≥n y filtros.</li>
                        <li><strong>src/app/api/invoices/[id]/route.ts</strong>: Maneja operaciones sobre facturas individuales (obtener, actualizar, eliminar).</li>
                        <li><strong>src/app/api/payments/route.ts</strong>: Obtiene lista paginada de pagos con filtros por rol, m√©todo de pago y rangos de monto.</li>
                        <li><strong>src/app/api/payments/[id]/route.ts</strong>: Obtiene detalles de un pago espec√≠fico, asegurando acceso solo al pagador o receptor.</li>
                        <li><strong>src/app/api/payments/stripe/checkout/route.ts</strong>: Crea sesiones de Stripe Checkout para que el deudor pague una factura en estado PENDING o OVERDUE.</li>
                        <li><strong>src/app/api/payments/stripe/session/[sessionId]/route.ts</strong>: Recupera el estado de una sesi√≥n de pago de Stripe y detalles de la factura asociada.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="chapter-nav">
            <div class="prev">
                <a href="capitulo10.html">
                    <span class="nav-label">‚Üê Anterior</span>
                    <span class="nav-title">Cap√≠tulo 10: Frontend de Facturas</span>
                </a>
            </div>
            <div class="next">
                <a href="capitulo12.html">
                    <span class="nav-label">Siguiente ‚Üí</span>
                    <span class="nav-title">Cap√≠tulo 12: Conexi√≥n con PayPal</span>
                </a>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>üìö Material educativo para aprender desarrollo full-stack moderno</p>
            <p>Basado en el proyecto <a href="https://github.com/GCousido/ClutchPay" target="_blank">ClutchPay</a></p>
        </div>
    </footer>
</body>
</html>