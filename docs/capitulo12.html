<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cap√≠tulo 12: Conexi√≥n con PayPal - ClutchPay</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>üí∞ ClutchPay</h1>
            <p class="subtitle">Cap√≠tulo 12: Conexi√≥n con PayPal</p>
        </div>
    </header>

    <nav class="main-nav">
        <div class="container">
            <a href="index.html">Inicio</a>
            <a href="capitulo12.html" class="active">Cap√≠tulo 12</a>
        </div>
    </nav>

    <main class="container">
        <div class="back-nav">
            <a href="index.html" class="back-btn">‚Üê Volver al √≠ndice</a>
        </div>

        <div class="chapter-content">
            <div class="chapter-header">
                <h1>Cap√≠tulo 12: Conexi√≥n con PayPal</h1>
            </div>

            <div class="video-embed">
                <iframe
                    src="https://drive.google.com/file/d/1gRXScOlgj24rNUSBcQ3MHsJkxaLG4OFi/preview"
                    title="Video tutorial - Cap√≠tulo 12"
                    allow="autoplay; encrypted-media"
                    allowfullscreen
                ></iframe>
            </div>

            <div class="content-section">
                <h2>üìñ Contenido Completo</h2>
                <div class="markdown-body">
                    <h1>Implementaci√≥n del Flujo de Pagos y Recibos</h1>
                    <p>En este tutorial se describe el proceso para implementar el flujo completo de procesamiento de pagos en ClutchPay, incluyendo la recepci√≥n de pagos v√≠a Stripe Checkout, la generaci√≥n de recibos en PDF, y la distribuci√≥n de fondos mediante PayPal Payouts.</p>
                    <p>El flujo est√° dise√±ado para ser <strong>seguro y tolerante a fallos</strong>, permitiendo manejar pagos s√≠ncronos y as√≠ncronos (como PayPal v√≠a Stripe).</p>
                    
                    <h2>1. Estructura de archivos de pagos y recibos</h2>
                    <ul>
                        <li><strong>src/libs/pdf-generator.ts</strong>: librer√≠a encargada de generar recibos de pago en formato PDF con branding de ClutchPay.</li>
                        <li><strong>src/libs/paypal.ts</strong>: integraci√≥n con PayPal Payouts para transferir fondos al emisor de la factura, incluyendo simulaci√≥n en entornos de desarrollo.</li>
                        <li><strong>src/app/api/payments/stripe/webhook/route.ts</strong>: endpoint webhook que procesa eventos de Stripe relacionados con pagos exitosos, pagos as√≠ncronos y expiraciones.</li>
                    </ul>
                    
                    <h2>2. src/libs/pdf-generator.ts</h2>
                    <p>Este archivo contiene la l√≥gica para generar recibos de pago en formato PDF utilizando <strong>PDFKit</strong>, aplicando estilos, colores y estructura visual consistente con la marca ClutchPay.</p>
                    
                    <h3>Funcionalidad principal</h3>
                    <ul>
                        <li>Genera un <strong>recibo electr√≥nico</strong> en formato PDF.</li>
                        <li>Incluye informaci√≥n de: Pago, Factura, Pagador y receptor</li>
                        <li>Aplica branding visual (colores, encabezado, logotipo).</li>
                        <li>Devuelve un <code>Buffer</code> listo para ser almacenado o subido a un proveedor externo (ej. Cloudinary).</li>
                    </ul>
                    
                    <h3>Interfaz de datos</h3>
                    <p><strong>ReceiptData</strong>:</p>
                    <ul>
                        <li>Referencia de pago</li>
                        <li>Fecha de pago</li>
                        <li>Monto y moneda</li>
                        <li>M√©todo de pago</li>
                        <li>N√∫mero de factura</li>
                        <li>Asunto</li>
                        <li>Datos del pagador y receptor</li>
                    </ul>
                    
                    <h3>Caracter√≠sticas clave</h3>
                    <ul>
                        <li>Encabezado con efecto de gradiente</li>
                        <li>Soporte para logotipo din√°mico</li>
                        <li>Dise√±o en dos columnas para detalles de pago y factura</li>
                        <li>Secci√≥n de partes involucradas (payer / receiver)</li>
                        <li>Pie de p√°gina con aviso legal</li>
                    </ul>
                    
                    <h2>3. src/libs/paypal.ts</h2>
                    <p>Este archivo implementa la integraci√≥n con <strong>PayPal Payouts SDK</strong>, permitiendo transferir autom√°ticamente fondos al emisor de la factura una vez confirmado el pago en Stripe.</p>
                    
                    <h3>Configuraci√≥n</h3>
                    <p>Variables de entorno requeridas:</p>
                    <ul>
                        <li><code>PAYPAL_CLIENT_ID</code></li>
                        <li><code>PAYPAL_CLIENT_SECRET</code></li>
                        <li><code>PAYPAL_MODE</code> (<code>sandbox</code> o <code>live</code>)</li>
                    </ul>
                    <p>El entorno se selecciona autom√°ticamente seg√∫n la configuraci√≥n.</p>
                    
                    <h3>Funcionalidades</h3>
                    <ul>
                        <li><strong>createPayPalPayout</strong>: Crea un payout a un email de PayPal, convierte montos de centavos a formato decimal, genera un <code>sender_batch_id</code> √∫nico, devuelve informaci√≥n del batch y la transacci√≥n.</li>
                        <li><strong>getPayoutStatus</strong>: Consulta el estado de un payout batch existente.</li>
                        <li><strong>calculateNetAfterFees</strong>: Calcula el monto neto despu√©s de comisiones estimadas.</li>
                        <li><strong>isValidPayPalEmail</strong>: Valida el formato de un email de PayPal.</li>
                    </ul>
                    
                    <h3>Modo simulaci√≥n</h3>
                    <p>Cuando las credenciales de PayPal no est√°n configuradas:</p>
                    <ul>
                        <li>Los payouts se <strong>simulan autom√°ticamente</strong></li>
                        <li>Se devuelven respuestas exitosas para permitir desarrollo y testing local</li>
                        <li>No se bloquea el flujo principal de pagos</li>
                    </ul>
                    
                    <h2>4. src/app/api/payments/stripe/webhook/route.ts</h2>
                    <p>Este archivo implementa el <strong>webhook de Stripe</strong>, encargado de procesar eventos relacionados con pagos realizados mediante Stripe Checkout.</p>
                </div>
            </div>
        </div>

        <div class="chapter-nav">
            <div class="prev">
                <a href="capitulo11.html">
                    <span class="nav-label">‚Üê Anterior</span>
                    <span class="nav-title">Cap√≠tulo 11: Pagos con Stripe</span>
                </a>
            </div>
            <div class="next">
                <a href="capitulo13.html">
                    <span class="nav-label">Siguiente ‚Üí</span>
                    <span class="nav-title">Cap√≠tulo 13: M√≥dulos Front Pagos</span>
                </a>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>üìö Material educativo para aprender desarrollo full-stack moderno</p>
            <p>Basado en el proyecto <a href="https://github.com/GCousido/ClutchPay" target="_blank">ClutchPay</a></p>
        </div>
    </footer>
</body>
</html>